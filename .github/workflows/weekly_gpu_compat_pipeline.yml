name: Weekly GPU Compatibility ETL

on:
  workflow_dispatch:
  schedule:
    # Runs every Monday at 03:00 UTC (adjust as needed)
    - cron: '0 15 * * 1'

concurrency:
  group: gpu-compat-weekly
  cancel-in-progress: false

jobs:
  run-etl:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
            sudo apt-get install -y --no-install-recommends \
              libcurl4-openssl-dev \
              libx11-dev

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Cache renv packages
        uses: actions/cache@v4
        with:
          path: renv/library
          key: renv-${{ runner.os }}-${{ hashFiles('**/renv.lock') }}
          restore-keys: |
            renv-${{ runner.os }}-

      - name: Restore renv
        run: |
          Rscript -e "if(!requireNamespace('renv', quietly=TRUE)) install.packages('renv'); renv::restore()"

      - name: Run pipeline (relaxed checks)
        env:
          R_ENVIRON_USER: ${{ github.workspace }}/.Renviron
        run: |
          Rscript scripts/run_scrapers_and_export.R --relaxed-checks

      - name: List processed outputs
        run: |
          ls -1 data/processed || echo 'processed directory missing'

      - name: Upload processed CSV and SQLite artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gpu-compat-data
          path: |
            data/processed/*.csv
            data/processed/gpu_compat.sqlite
          retention-days: 21

      - name: (Optional) Commit updated processed data
        if: false
        run: |
          echo "Enable this step by setting if: true and configuring a suitable PAT with repo write permissions."

      - name: Summary
        run: |
          echo "Weekly GPU compatibility ETL complete."
